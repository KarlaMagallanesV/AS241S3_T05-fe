<div class="table-container">
  <!-- Filtros superiores -->
  <div class="filters-section">
    <div class="filters-left">
      <select class="filter-select" [(ngModel)]="ctgTypeFilter" (change)="applyFilters()">
        <option value="">Categoria</option>
        @for (cat of Category; track cat) {
          <option [value]="cat">{{ cat }}</option>
        }
      </select>

      <span class="filter-label">ESTADO:</span>
      <button class="filter-btn check-btn" [class.active]="statusFilter === 'true'"
        (click)="statusFilter='true'; applyFilters()">
        <i class="fas fa-check"></i>
      </button>
      <button class="filter-btn times-btn" [class.active]="statusFilter === 'false'"
        (click)="statusFilter='false'; applyFilters()">
        <i class="fas fa-times"></i>
      </button>

      <select class="filter-select" [(ngModel)]="durationFilter" (change)="applyFilters()">
        <option value="">Duración</option>
        @for (range of durationRanges; track range) {
          <option [value]="range.label">{{ range.label }}</option>
        }
      </select>

      <select class="filter-select" [(ngModel)]="priceFilter" (change)="applyFilters()">
        <option value="">Precio</option>
        @for (range of priceRanges; track range) {
          <option [value]="range.label">{{ range.label }}</option>
        }
      </select>
    </div>

    <div class="filters-right">
      <span class="filter-label">ORDENAR:</span>
      <button class="filter-btn" [class.active]="sortOption==='name_asc'"
      (click)="sortOption='name_asc'; sortServices()">A - Z</button>
      <button class="filter-btn" [class.active]="sortOption==='name_desc'"
      (click)="sortOption='name_desc'; sortServices()">Z - A</button>
      <button class="filter-btn" [class.active]="sortOption==='price_asc'"
      (click)="sortOption='price_asc'; sortServices()">Precio ↑</button>
      <button class="filter-btn" [class.active]="sortOption==='price_desc'"
      (click)="sortOption='price_desc'; sortServices()">Precio ↓</button>

      <button class="filter-btn reset-btn" (click)="resetFilters()" title="Reiniciar filtros">
        <i class="fas fa-redo"></i>
      </button>
    </div>
  </div>

  <!-- Tabla de servicios -->
  <div class="table-wrapper">
    <table class="clients-table">
      <thead>
        <tr>
          <th>CATEGORÍA</th>
          <th>SERVICIO</th>
          <th>DESCRIPCIÓN</th>
          <th>DURACIÓN</th>
          <th>PRECIO</th>
          <th>PUNTOS</th>
          <th>ESTADO</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        @for (service of paginatedServices; track service) {
          <tr
            [class.highlighted]="selectedService?.code === service.code">
            <td>{{ service.category }}</td>
            <td>{{ service.name_service }}</td>
            <td>{{ service.description_service }}</td>
            <td>{{ service.duration }}</td>
            <td>{{ service.price }}</td>
            <td>{{ service.points }}</td>
            <td>
              <span class="status-badge" [class.active]="service.status" [class.inactive]="!service.status">
                {{ service.status ? 'ACTIVO' : 'INACTIVO' }}
              </span>
            </td>
            <td class="actions-cell">
              <button class="action-btn view-btn" (click)="openModal(service)" title="Ver">
                <i class="fas fa-eye"></i>
              </button>
              @if (service.status) {
                <button class="action-btn edit-btn" (click)="openModalEdit(service)"
                  title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
              }
              <button class="action-btn toggle-btn" (click)="toggleState(service.code, service.status!)"
                title="Cambiar estado">
                <i class="fa" [ngClass]="service.status ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Modal unificado para vista/edición -->
  @if (showModal || showModalEdit) {
    <div class="modal"
      (click)="showModal ? closeModal($event) : closeModalEdit($event)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <span class="close-btn" (click)="showModal ? closeModal($event) : closeModalEdit($event)">×</span>
        <h2>{{ showModal ? 'Información del Servicio' : 'Actualizar Servicio' }}</h2>
        <!-- Vista -->
        @if (showModal) {
          <div>
            <div class="info-row"><span class="info-label">Código:</span> <span class="info-value">{{
          selectedService?.code }}</span></div>
          <div class="info-row"><span class="info-label">Categoría:</span> <span class="info-value">{{
        selectedService?.category }}</span></div>
        <div class="info-row"><span class="info-label">Nombre:</span> <span class="info-value">{{
      selectedService?.name_service }}</span></div>
      <div class="info-row"><span class="info-label">Descripción:</span> <span class="info-value">{{
    selectedService?.description_service }}</span></div>
    <div class="info-row"><span class="info-label">Duración (min):</span> <span class="info-value">{{
  selectedService?.duration }}</span></div>
  <div class="info-row"><span class="info-label">Precio:</span> <span class="info-value">S/ {{
selectedService?.price | number:'1.2-2' }}</span></div>
<div class="info-row"><span class="info-label">Puntos:</span> <span class="info-value">{{
selectedService?.points }}</span></div>
@if (selectedService?.image_url) {
  <div class="info-row image-preview-row">
    <span class="info-label">Imagen:</span>
    <img [src]="selectedService?.image_url" alt="Imagen del servicio" class="modal-image-preview">
  </div>
}
<div class="info-row"><span class="info-label">Fecha de registro:</span> <span class="info-value">{{
selectedService?.registration_date | date:'dd/MM/yyyy HH:mm' }}</span></div>
<div class="info-row"><span class="info-label">Estado:</span>
<span class="status-badge" [class.active]="selectedService?.status"
  [class.inactive]="!selectedService?.status">
  {{ selectedService?.status ? 'Activo' : 'Inactivo' }}
</span>
</div>
</div>
}
<!-- Edición -->
@if (showModalEdit) {
  <form [formGroup]="formEdit" (ngSubmit)="onUpdate()">
    <div class="form-row">
      <div class="form-group">
        <label>Código:</label>
        <input type="text" formControlName="code" readonly>
      </div>
      <div class="form-group">
        <label>Categoría:</label>
        <input type="text" formControlName="category" readonly>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Nombre del servicio:</label>
        <input type="text" formControlName="nameService" maxlength="50" (keydown)="onlyLetters($event)">
        @if (formEdit.get('nameService')?.invalid && formEdit.get('nameService')?.touched) {
          <span
          class="error">Nombre inválido</span>
        }
      </div>
      <div class="form-group">
        <label>Duración (min):</label>
        <input type="number" formControlName="duration">
        @if (formEdit.get('duration')?.invalid && formEdit.get('duration')?.touched) {
          <span
          class="error">Duración inválida</span>
        }
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Precio:</label>
        <input type="text" formControlName="price"
          (keydown)="onlyPrice($event, formEdit.get('price')?.value)">
          @if (formEdit.get('price')?.invalid && formEdit.get('price')?.touched) {
            <span
            class="error">Precio inválido</span>
          }
        </div>
        <div class="form-group">
          <label>Puntos:</label>
          <input type="number" formControlName="points">
          @if (formEdit.get('points')?.invalid && formEdit.get('points')?.touched) {
            <span
            class="error">Puntos inválidos</span>
          }
        </div>
      </div>
      <div class="form-group">
        <label>Descripción:</label>
        <textarea formControlName="descriptionService" rows="3" maxlength="500"></textarea>
        @if (formEdit.get('descriptionService')?.invalid && formEdit.get('descriptionService')?.touched) {
          <span
          class="error">Descripción inválida</span>
        }
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Imagen del Servicio:</label>
          <input type="hidden" formControlName="image_url">
          <input type="file" id="image_file" (change)="onFileSelected($event)" formControlName="image_file" accept="image/*">
        </div>
        <div class="form-group image-preview-group">
          <label>Previsualización:</label>
          @if (selectedImageUrl) {
            <img [src]="selectedImageUrl" alt="Previsualización" class="modal-image-preview"
              >
          }
          @if (!selectedImageUrl) {
            <div class="image-placeholder">No hay imagen.</div>
          }
        </div>
      </div>
      <div class="button-container">
        <button type="submit" class="view-btn-edit"><i class="fas fa-pen fa-xs"></i> Actualizar</button>
      </div>
    </form>
  }
</div>
</div>
}

<!-- Paginación -->
<div class="pagination-section">
  <span class="pagination-info">Página {{ currentPage }} de {{ totalPages }}</span>
  <div class="pagination-controls">
    <button class="pagination-btn" (click)="prevPage()" [disabled]="currentPage === 1"><i
    class="fas fa-chevron-left"></i></button>
    <button class="pagination-btn" (click)="nextPage()" [disabled]="currentPage === totalPages"><i
    class="fas fa-chevron-right"></i></button>
  </div>
</div>
</div>